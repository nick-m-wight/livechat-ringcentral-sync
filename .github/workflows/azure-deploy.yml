name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

env:
  ACR_NAME: livechatsync1771269315
  IMAGE_NAME: livechat-sync-app
  RESOURCE_GROUP: livechat-sync-rg
  CONTAINER_APP_NAME: livechat-sync-app
  CELERY_WORKER_NAME: livechat-sync-celery-worker
  CELERY_BEAT_NAME: livechat-sync-celery-beat

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --no-root

      - name: Run linting (optional)
        continue-on-error: true  # Don't fail build if linting fails
        run: |
          poetry run ruff check app/ tests/ || true

      - name: Run tests (optional)
        continue-on-error: true  # Don't fail build if tests fail
        run: |
          poetry run pytest tests/ -v || true

  build-and-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    # Only run on push to main/master, not on PRs
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          echo ${{ secrets.ACR_PASSWORD }} | docker login ${{ secrets.ACR_LOGIN_SERVER }} \
            --username ${{ secrets.ACR_USERNAME }} \
            --password-stdin

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest \
            -f docker/Dockerfile .

      - name: Push Docker image
        run: |
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

      - name: Log out from ACR
        run: docker logout ${{ secrets.ACR_LOGIN_SERVER }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    # Only run on push to main/master
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy main app to Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy Celery worker to Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CELERY_WORKER_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy Celery beat to Container Apps
        run: |
          az containerapp update \
            --name ${{ env.CELERY_BEAT_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Run database migrations
        run: |
          az containerapp exec \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --command "alembic upgrade head" || echo "Migration failed or not needed"

      - name: Get application URL
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          echo "Application URL: https://$APP_URL"
          echo "Health check: https://$APP_URL/health"
          echo "Dashboard: https://$APP_URL/demo/"

      - name: Verify deployment
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            -o tsv)

          # Wait a bit for app to start
          sleep 10

          # Try to hit health endpoint
          curl -f https://$APP_URL/health || echo "Health check failed, app may still be starting"

      - name: Azure logout
        run: |
          az logout
